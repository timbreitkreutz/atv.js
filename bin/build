#!/bin/bash

# All the Lints!
for f in atv.js atv/*.js; do
  node jslint.mjs $f

  npx eslint $f || quit "Please fix eslint"
  npx prettier --trailing-comma none $f --write
done

# All the Tests!

cd atv-test; bin/rails assets:clobber; bin/rails test:system || exit "Please fix tests"

# Package for distribution

cd -
echo "/*global document, console, MutationObserver */" > atv-dist.js
grep -v "^import" atv.js | grep -v "^export" >> atv-dist.js
for f in atv/*.js; do
  sed -e "/ATV/,\$!d" $f |
  sed -e "/^export/,\$d" >> atv-dist.js
done
echo "export { activate, version };" >> atv-dist.js
npx eslint atv-dist.js || quit "Please fix eslint for atv-dist.js"


echo "Build succeeded"
